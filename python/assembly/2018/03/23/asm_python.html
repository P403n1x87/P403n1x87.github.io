<!DOCTYPE html>
<html>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Extending Python with Assembly</title>
  <meta name="description" content="What's a better way to fill an empty evening if not by reading about how to extend Python with Assembly? I bet you don't even know where to start to answer t...">
  <meta name="theme-color" content="#100808" />

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://p403n1x87.github.io//python/assembly/2018/03/23/asm_python.html">
  <link rel="alternate" type="application/rss+xml" title="The Hub of Heliopolis" href="https://p403n1x87.github.io//feed.xml">
</head>


  <body>

    <header class="site-header">
  <div class="site-title">
    ~# <a href="/">the-<strong>hub</strong>-of-heliopolis</a><span class="blinking-cursor">&block;</span>
  </div>
  <div class="wrapper">
    <nav class="site-nav">
      <div class="trigger">
        
          
        
          
          <a class="page-link" href="/">Posts</a>
          
        
          
        
          
          <a class="page-link" href="/about/">About</a>
          
        
      </div>
    </nav>

  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <h1 class="post-title" itemprop="name headline">Extending Python with Assembly</h1>

<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="sidepane post-header">
    
    <div class="post-info">
  <div class="post-detail"><i class="fa fa-calendar-plus-o" aria-hidden="true"></i>&nbsp;2018 Mar 23</div>
  <div class="post-detail"><i class="fa fa-clock-o" aria-hidden="true"></i>&nbsp;<span class="reading-time" title="Estimated read time">
  
  
    a 24 minute read
  
</span>
</div>
  <div class="flex-container flex-row post-detail">
  <div><i class="fa fa-archive" aria-hidden="true"></i></div>&nbsp;
  <div><span class="category">Python</span><span class="category">Assembly</span></div>
</div>
<div class="flex-container flex-row post-detail">
  <div><i class="fa fa-tags" aria-hidden="true"></i></div>&nbsp;
  <div class="flex-container flex-row flex-wrap"><span class="tag">Python</span><span class="tag">Assembly</span></div>
</div>

  
    <div class="post-detail"><i class="fa fa-github" aria-hidden="true"></i>&nbsp;<a href="https://github.com/P403n1x87/asm/tree/master/python">P403n1x87/asm/python</a></div>
  
</div>


    <div class="toc">
      <div class="heading">Table of Contents</div>
      <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#introduction">Introduction</a></li>
<li class="toc-entry toc-h1"><a href="#the-code">The Code</a>
<ul>
<li class="toc-entry toc-h2"><a href="#shared-object">Shared Object</a></li>
<li class="toc-entry toc-h2"><a href="#the-cpython-headers">The CPython Headers</a></li>
<li class="toc-entry toc-h2"><a href="#exporting-global-symbols">Exporting Global Symbols</a></li>
<li class="toc-entry toc-h2"><a href="#immutable-strings">Immutable Strings</a></li>
<li class="toc-entry toc-h2"><a href="#cpython-data-structures">CPython Data Structures</a></li>
<li class="toc-entry toc-h2"><a href="#local-and-global-functions">Local and Global Functions</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#installation">Installation</a>
<ul>
<li class="toc-entry toc-h2"><a href="#assembling-and-linking">Assembling and Linking</a></li>
<li class="toc-entry toc-h2"><a href="#how-to-test-the-module">How to Test the Module</a></li>
<li class="toc-entry toc-h2"><a href="#distributing-the-module">Distributing the Module</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#conclusions">Conclusions</a></li>
</ul>
    </div>

  </header>

  <div class="post-text">

    <div class="post-excerpt">
      <p>What’s a better way to fill an empty evening if not by reading about how to extend Python with Assembly? I bet you don’t even know where to start to answer this question :P. But if you’re curious to know how you can use another language to extend Python, and if you happen to like Assembly programming, you might end up actually enjoying this post (I hope!).</p>

    </div>

    <div class="post-content" itemprop="articleBody">
      <h1 id="introduction">
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h1>

<p>If you have landed on this page, you must have had one between two only possible reactions to the title of this post, either “Hmm, this sounds interesting” or “Just, why?”. The straight answer is, well, “just, because”. And perhaps a bit more articulated answer is: because the people in the first category probably enjoy this kind of things :).</p>

<p>Reactions aside, the subject of this post is the coding of an extension for Python written in pure Assembly for the Intel x86-64 architecture on a Linux-based operating system. If you are familiar with general assembly but have never coded for the architecture that we are targeting, it is perhaps worth reading through my previous post “<a href="/assembly/x86_64/2016/08/10/getting-started-with-x68-asm.html">Getting Started with x86-64 Assembly on Linux</a>”.</p>

<p>I will also assume that you are somewhat familiar with extending Python with C. If not, then it probably is a good idea to go through the <a href="https://docs.python.org/3/extending/extending.html">official documentation</a> before reading on, or some things might not make too much sense. The approach of this post is by example and builds on knowledge about C to transition to Assembly. My favourite assembler on Linux is NASM, since it supports the Intel syntax, the one that I am more comfortable with. Therefore the only dependencies for following along are the NASM assembler and the GNU linker <code class="highlighter-rouge">ld</code>. Optionally, we can make use of a <code class="highlighter-rouge">Makefile</code> to assemble and link our code, and perhaps <code class="highlighter-rouge">docker</code> to test it in a clean environment. You will find all the relevant files in the linked <a href="https://github.com/P403n1x87/asm/tree/master/python">GitHub repository</a>.</p>

<p>Now it’s time to jump straight into the code.</p>

<h1 id="the-code">
<a id="the-code" class="anchor" href="#the-code" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Code</h1>

<p>There isn’t much more to say before we can see the code really, so here it is. This is the content of my <code class="highlighter-rouge">asm.asm</code> source file.</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td>
<td class="code"><pre><span class="n">DEFAULT</span>                 <span class="n">rel</span>

<span class="cp">%include</span>                <span class="s">"asm/python.inc"</span>

<span class="kr">GLOBAL</span>                  <span class="n">PyInit_asm</span><span class="o">:</span><span class="n">function</span>


<span class="c">;; ---------------------------------------------------------------------------</span>
<span class="kr">SECTION</span>                 <span class="p">.</span><span class="n">rodata</span>
<span class="c">;; ---------------------------------------------------------------------------</span>

<span class="n">l_sayit_name</span>            <span class="kt">db</span> <span class="s">"sayit"</span><span class="p">,</span> <span class="mi">0</span>
<span class="n">l_sayit_doc</span>             <span class="kt">db</span> <span class="s">"This method has something important to say."</span><span class="p">,</span> <span class="mi">0</span>
<span class="n">l_sayit_msg</span>             <span class="kt">db</span> <span class="s">"Assembly is great fun! :)"</span><span class="p">,</span> <span class="mi">10</span>
<span class="n">l_sayit_msg_len</span>         <span class="k">equ</span> <span class="err">$</span> <span class="o">-</span> <span class="n">l_sayit_msg</span>

<span class="n">l_module_name</span>           <span class="kt">db</span> <span class="s">"asm"</span><span class="p">,</span> <span class="mi">0</span>


<span class="c">;; ---------------------------------------------------------------------------</span>
<span class="kr">SECTION</span>                 <span class="p">.</span><span class="n">data</span>
<span class="c">;; ---------------------------------------------------------------------------</span>

<span class="n">l_asm_methods</span><span class="o">:</span>              <span class="c">;; struct PyMethodDef[] *</span>
<span class="n">ISTRUC</span> <span class="n">PyMethodDef</span>
  <span class="n">at</span> <span class="n">PyMethodDef</span><span class="p">.</span><span class="n">ml_name</span>    <span class="p">,</span> <span class="kt">dq</span> <span class="n">l_sayit_name</span>
  <span class="n">at</span> <span class="n">PyMethodDef</span><span class="p">.</span><span class="n">ml_meth</span>    <span class="p">,</span> <span class="kt">dq</span> <span class="n">asm_sayit</span>
  <span class="n">at</span> <span class="n">PyMethodDef</span><span class="p">.</span><span class="n">ml_flags</span>   <span class="p">,</span> <span class="kt">dq</span> <span class="n">METH_NOARGS</span>
  <span class="n">at</span> <span class="n">PyMethodDef</span><span class="p">.</span><span class="n">ml_doc</span>     <span class="p">,</span> <span class="kt">dq</span> <span class="n">l_sayit_doc</span>
<span class="n">IEND</span>
<span class="n">NullMethodDef</span>

<span class="n">l_asm_module</span><span class="o">:</span>                <span class="c">;; struct PyModuleDef *</span>
<span class="n">ISTRUC</span> <span class="n">PyModuleDef</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_base</span>     <span class="p">,</span> <span class="n">PyModuleDef_HEAD_INIT</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_name</span>     <span class="p">,</span> <span class="kt">dq</span> <span class="n">l_module_name</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_doc</span>      <span class="p">,</span> <span class="kt">dq</span> <span class="n">NULL</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_size</span>     <span class="p">,</span> <span class="kt">dq</span> <span class="o">-</span><span class="mi">1</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_methods</span>  <span class="p">,</span> <span class="kt">dq</span> <span class="n">l_asm_methods</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_slots</span>    <span class="p">,</span> <span class="kt">dq</span> <span class="n">NULL</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_traverse</span> <span class="p">,</span> <span class="kt">dq</span> <span class="n">NULL</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_clear</span>    <span class="p">,</span> <span class="kt">dq</span> <span class="mi">0</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_free</span>     <span class="p">,</span> <span class="kt">dq</span> <span class="n">NULL</span>
<span class="n">IEND</span>


<span class="c">;; ---------------------------------------------------------------------------</span>
<span class="kr">SECTION</span>                 <span class="p">.</span><span class="n">text</span>
<span class="c">;; ---------------------------------------------------------------------------</span>

<span class="n">asm_sayit</span><span class="o">:</span> <span class="c">;; ----------------------------------------------------------------</span>
                        <span class="k">push</span>  <span class="n">rbp</span>
                        <span class="k">mov</span>   <span class="n">rbp</span><span class="p">,</span> <span class="n">rsp</span>

                        <span class="k">mov</span>   <span class="n">rax</span><span class="p">,</span> <span class="mi">1</span>                  <span class="c">; SYS_WRITE</span>
                        <span class="k">mov</span>   <span class="n">rdi</span><span class="p">,</span> <span class="mi">1</span>                  <span class="c">; STDOUT</span>
                        <span class="k">mov</span>   <span class="n">rsi</span><span class="p">,</span> <span class="n">l_sayit_msg</span>
                        <span class="k">mov</span>   <span class="n">rdx</span><span class="p">,</span> <span class="n">l_sayit_msg_len</span>
                        <span class="k">syscall</span>

                        <span class="k">mov</span>   <span class="n">rax</span><span class="p">,</span> <span class="n">Py_None</span>
                        <span class="k">inc</span>   <span class="n">QWORD</span> <span class="err">[</span><span class="n">rax</span> <span class="o">+</span> <span class="n">PyObject</span><span class="p">.</span><span class="n">ob_refcnt</span><span class="err">]</span>

                        <span class="k">pop</span>   <span class="n">rbp</span>
                        <span class="k">ret</span>
<span class="c">;; end asm_sayit</span>


<span class="n">PyInit_asm</span><span class="o">:</span> <span class="c">;; --------------------------------------------------------------</span>
                        <span class="k">push</span>  <span class="n">rbp</span>
                        <span class="k">mov</span>   <span class="n">rbp</span><span class="p">,</span> <span class="n">rsp</span>

                        <span class="k">mov</span>   <span class="n">rsi</span><span class="p">,</span> <span class="n">PYTHON_API_VERSION</span>
                        <span class="k">mov</span>   <span class="n">rdi</span><span class="p">,</span> <span class="n">l_asm_module</span>
                        <span class="k">call</span>  <span class="n">PyModule_Create2</span> <span class="n">WRT</span> <span class="p">..</span><span class="n">plt</span>

                        <span class="k">pop</span>   <span class="n">rbp</span>
                        <span class="k">ret</span>
<span class="c">;; end PyInit_asm</span></pre></td>
</tr></tbody></table></code></pre></figure>

<p>If you have never written a C extension for Python before, this might look a bit mysterious to you, although the general structure, at least, should be quite clear after you’ve glimpsed through the official Python documentation on extending Python with C.</p>

<p>We shall now analyse every single part of the above code sample in details to see what each block of code does.</p>

<h2 id="shared-object">
<a id="shared-object" class="anchor" href="#shared-object" aria-hidden="true"><span class="octicon octicon-link"></span></a>Shared Object</h2>

<p>On the very first line of the source we see the line</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="n">DEFAULT</span>                 <span class="n">rel</span></code></pre></figure>

<p>Our goal is to assemble and link our code into an ELF64 <em>shared object</em> file. Contrary to ordinary program code, shared object files are dynamically loaded into random memory addresses. It is therefore important that all our code is <em>position-independent</em>. One way of doing this is to make sure that any memory reference is not absolute, but relative to the value of the <code class="highlighter-rouge">RIP</code> register, which points to the current instruction being executed. This guarantees that, no matter where the shared object is loaded into memory, references to local variables are correct. In 64-bit mode, NASM defaults to absolute addresses, therefore the above line is necessary to switch to <code class="highlighter-rouge">RIP</code>-relative addresses.</p>

<h2 id="the-cpython-headers">
<a id="the-cpython-headers" class="anchor" href="#the-cpython-headers" aria-hidden="true"><span class="octicon octicon-link"></span></a>The CPython Headers</h2>

<p>On line 3 we include a file to our main Assembly source. Given the simplicity of this example, we could have included the content of the <code class="highlighter-rouge">python.inc</code> file within <code class="highlighter-rouge">asm.asm</code> itself. However, for larger projects it is perhaps good practice to separate declarations and actual code, like it is usually done in C, with <code class="highlighter-rouge">.h</code> and <code class="highlighter-rouge">.c</code> files. In fact, the <code class="highlighter-rouge">python.inc</code> file includes the equivalent of structures and macros as declared in the CPython header files. As far as I’m aware, there are no assembly-specific include files provided by the maintainers of CPython, so we have to go through the extra effort of typing them ourselves. We will get back to the content of this file later on.</p>

<h2 id="exporting-global-symbols">
<a id="exporting-global-symbols" class="anchor" href="#exporting-global-symbols" aria-hidden="true"><span class="octicon octicon-link"></span></a>Exporting Global Symbols</h2>

<p>Line 5 is an important one. It exports the symbol <code class="highlighter-rouge">PyInit_asm</code>, of type <code class="highlighter-rouge">function</code>, and makes it available for external programs. This is the function that CPython calls the moment we load the <code class="highlighter-rouge">asm</code> module with <code class="highlighter-rouge">import asm</code> from the Python interpreter. If we do not export this symbol, then CPython won’t be able to find the code necessary to initialise the module. In analogy with C, this is equivalent to declaring a non-static function.</p>

<h2 id="immutable-strings">
<a id="immutable-strings" class="anchor" href="#immutable-strings" aria-hidden="true"><span class="octicon octicon-link"></span></a>Immutable Strings</h2>

<p>Next we have the read-only data section</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="c">;; ---------------------------------------------------------------------------</span>
<span class="kr">SECTION</span>                 <span class="p">.</span><span class="n">rodata</span>
<span class="c">;; ---------------------------------------------------------------------------</span>

<span class="n">l_sayit_name</span>            <span class="kt">db</span> <span class="s">"sayit"</span><span class="p">,</span> <span class="mi">0</span>
<span class="n">l_sayit_doc</span>             <span class="kt">db</span> <span class="s">"This method has something important to say."</span><span class="p">,</span> <span class="mi">0</span>
<span class="n">l_sayit_msg</span>             <span class="kt">db</span> <span class="s">"Assembly is great fun! :)"</span><span class="p">,</span> <span class="mi">10</span>
<span class="n">l_sayit_msg_len</span>         <span class="k">equ</span> <span class="err">$</span> <span class="o">-</span> <span class="n">l_sayit_msg</span>

<span class="n">l_module_name</span>           <span class="kt">db</span> <span class="s">"asm"</span><span class="p">,</span> <span class="mi">0</span></code></pre></figure>

<p>Here we initialise the strings that we will need later on. As they won’t change during the course of the code execution, we put them in a read-only section of the shared object. The GNU C compiler does just the same thing with every literal string that you use in C code. You will notice references to their address in the following section, that of (read-write) initialised data.</p>

<h2 id="cpython-data-structures">
<a id="cpython-data-structures" class="anchor" href="#cpython-data-structures" aria-hidden="true"><span class="octicon octicon-link"></span></a>CPython Data Structures</h2>

<p>Next is the section of initialised data.</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="c">;; ---------------------------------------------------------------------------</span>
<span class="kr">SECTION</span>                 <span class="p">.</span><span class="n">data</span>
<span class="c">;; ---------------------------------------------------------------------------</span>

<span class="n">l_asm_methods</span><span class="o">:</span>              <span class="c">;; struct PyMethodDef[] *</span>
<span class="n">ISTRUC</span> <span class="n">PyMethodDef</span>
  <span class="n">at</span> <span class="n">PyMethodDef</span><span class="p">.</span><span class="n">ml_name</span>    <span class="p">,</span> <span class="kt">dq</span> <span class="n">l_sayit_name</span>
  <span class="n">at</span> <span class="n">PyMethodDef</span><span class="p">.</span><span class="n">ml_meth</span>    <span class="p">,</span> <span class="kt">dq</span> <span class="n">asm_sayit</span>
  <span class="n">at</span> <span class="n">PyMethodDef</span><span class="p">.</span><span class="n">ml_flags</span>   <span class="p">,</span> <span class="kt">dq</span> <span class="n">METH_NOARGS</span>
  <span class="n">at</span> <span class="n">PyMethodDef</span><span class="p">.</span><span class="n">ml_doc</span>     <span class="p">,</span> <span class="kt">dq</span> <span class="n">l_sayit_doc</span>
<span class="n">IEND</span>
<span class="n">NullMethodDef</span>

<span class="n">l_asm_module</span><span class="o">:</span>               <span class="c">;; struct PyModuleDef *</span>
<span class="n">ISTRUC</span> <span class="n">PyModuleDef</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_base</span>     <span class="p">,</span> <span class="n">PyModuleDef_HEAD_INIT</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_name</span>     <span class="p">,</span> <span class="kt">dq</span> <span class="n">l_module_name</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_doc</span>      <span class="p">,</span> <span class="kt">dq</span> <span class="n">NULL</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_size</span>     <span class="p">,</span> <span class="kt">dq</span> <span class="o">-</span><span class="mi">1</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_methods</span>  <span class="p">,</span> <span class="kt">dq</span> <span class="n">l_asm_methods</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_slots</span>    <span class="p">,</span> <span class="kt">dq</span> <span class="n">NULL</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_traverse</span> <span class="p">,</span> <span class="kt">dq</span> <span class="n">NULL</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_clear</span>    <span class="p">,</span> <span class="kt">dq</span> <span class="mi">0</span>
  <span class="n">at</span> <span class="n">PyModuleDef</span><span class="p">.</span><span class="n">m_free</span>     <span class="p">,</span> <span class="kt">dq</span> <span class="n">NULL</span>
<span class="n">IEND</span></code></pre></figure>

<p>Here is where things start to get interesting, and the content of the <code class="highlighter-rouge">python.inc</code> file comes into play. The first two labels point to the beginning of CPython-specific structures. The first is an array of <code class="highlighter-rouge">PyMethodDef</code> structures. As the name suggests, each instance of this structure is used to hold information about a method that should be made available to the Python interpreter from within our module. To find out in which header file it is defined, we can use the command</p>

<div class="terminal"><div class="terminal-body flex-container flex-row">
<div class="pad-right"><pre>$ </pre></div>
<div><pre>
grep -nr /usr/include/python3.6 -e "struct PyMethodDef"
</pre></div>
</div></div>

<p>In my case, I get that the structure is defined in <code class="highlighter-rouge">/usr/include/python3.6/methodobject.h</code>, starting from line 54. Inside the <code class="highlighter-rouge">python.inc</code> we then have the equivalent structure declaration</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="n">STRUC</span> <span class="n">PyMethodDef</span>
  <span class="p">.</span><span class="n">ml_name</span>              <span class="kt">resq</span> <span class="mi">1</span>    <span class="c">; const char *</span>
  <span class="p">.</span><span class="n">ml_meth</span>              <span class="kt">resq</span> <span class="mi">1</span>    <span class="c">; PyCFunction</span>
  <span class="p">.</span><span class="n">ml_flags</span>             <span class="kt">resq</span> <span class="mi">1</span>    <span class="c">; int</span>
  <span class="p">.</span><span class="n">ml_doc</span>               <span class="kt">resq</span> <span class="mi">1</span>    <span class="c">; const char *</span>
<span class="n">ENDSTRUC</span></code></pre></figure>

<p>The <code class="highlighter-rouge">NullMethodDef</code> is a NASM macro that conveniently defines the <em>sentinel</em> <code class="highlighter-rouge">PyMethodDef</code> structure, which is used to mark the end of the <code class="highlighter-rouge">PyMethodDef</code> array pointed by <code class="highlighter-rouge">l_asm_methods</code>. Its definition is also in the <code class="highlighter-rouge">python.inc</code> file and, as you can see, simply initialises a new instance of the structure with all the fields set to <code class="highlighter-rouge">NULL</code> or 0, depending on their semantics, i.e. whether they are memory pointers or general integers.</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="cp">%define</span> <span class="n">NullMethodDef</span>         <span class="kt">dq</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NULL</span></code></pre></figure>

<blockquote>
  <p>Note that <code class="highlighter-rouge">NULL</code> is not a native NASM value. To align the coding conventions with C, I have defined NULL as a constant in <code class="highlighter-rouge">python.inc</code> and assigned the value of 0 to it. The idea is that, like in C, it makes the intent of the code clearer, since any occurrence of <code class="highlighter-rouge">NULL</code> indicates a null pointer rather than just the literal value 0.</p>
</blockquote>

<p>The next label, <code class="highlighter-rouge">l_asm_module</code>, points to an instance of the <code class="highlighter-rouge">PyModuleDef</code> structure, which is pretty much the core data structure of our Python module. It contains all the relevant metadata that is then passed to CPython for correct initialisation and use of the module. Its definition is in the <code class="highlighter-rouge">moduleobject.h</code> header file and, at first sight, looks a bit complicated, with some references to other structures and C macros.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">PyModuleDef</span><span class="p">{</span>
  <span class="n">PyModuleDef_Base</span> <span class="n">m_base</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">m_name</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">m_doc</span><span class="p">;</span>
  <span class="n">Py_ssize_t</span> <span class="n">m_size</span><span class="p">;</span>
  <span class="n">PyMethodDef</span> <span class="o">*</span><span class="n">m_methods</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">PyModuleDef_Slot</span><span class="o">*</span> <span class="n">m_slots</span><span class="p">;</span>
  <span class="n">traverseproc</span> <span class="n">m_traverse</span><span class="p">;</span>
  <span class="n">inquiry</span> <span class="n">m_clear</span><span class="p">;</span>
  <span class="n">freefunc</span> <span class="n">m_free</span><span class="p">;</span>
<span class="p">}</span> <span class="n">PyModuleDef</span><span class="p">;</span></code></pre></figure>

<p>So lets take our time to figure out what its byte content looks like. The first field is an instance of the <code class="highlighter-rouge">PyModuleDef_Base</code> structure, which is defined in the same header file, just a few lines above. The non-trivial bit in this new structure is the first part, <code class="highlighter-rouge">PyObject_HEAD</code>, which looks like a C macro. As the name suggest, its definition is quite likely to be found in <code class="highlighter-rouge">object.h</code>. Indeed, there we find</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define PyObject_HEAD                   PyObject ob_base;</span></code></pre></figure>

<p>so our chase continues. The definition of the <code class="highlighter-rouge">PyObject</code> structure can be found a few lines below. Again, all the fields are quite simple, i.e. just integers value or memory pointers, except for the macro <code class="highlighter-rouge">_PyObject_HEAD_EXTRA</code>. We then have to jump back up a few lines, to find that this macro is conditionally defined as either nothing or <code class="highlighter-rouge">0, 0</code>. By default, the macro <code class="highlighter-rouge">Py_TRACE_REFS</code> is not defined, so in our case <code class="highlighter-rouge">_PyObject_HEAD_EXTRA</code> evaluates to nothing. Backtracking from our macro chase in CPython headers, we see that we can define the following structures in <code class="highlighter-rouge">python.inc</code></p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="n">STRUC</span> <span class="n">PyObject</span>
  <span class="p">.</span><span class="n">ob_refcnt</span>            <span class="kt">resq</span> <span class="mi">1</span>    <span class="c">; Py_ssize_t</span>
  <span class="p">.</span><span class="n">ob_type</span>              <span class="kt">resq</span> <span class="mi">1</span>    <span class="c">; struct _typeobject *</span>
<span class="n">ENDSTRUC</span>

<span class="n">STRUC</span> <span class="n">PyModuleDef_Base</span>
  <span class="p">.</span><span class="n">ob_base</span>              <span class="kt">resb</span> <span class="n">PyObject_size</span>
  <span class="p">.</span><span class="n">m_init</span>               <span class="kt">resq</span> <span class="mi">1</span>    <span class="c">; PyObject *</span>
  <span class="p">.</span><span class="n">m_index</span>              <span class="kt">resq</span> <span class="mi">1</span>    <span class="c">; Py_ssize_t</span>
  <span class="p">.</span><span class="n">m_copy</span>               <span class="kt">resq</span> <span class="mi">1</span>    <span class="c">; PyObject *</span>
<span class="n">ENDSTRUC</span>

<span class="n">STRUC</span> <span class="n">PyModuleDef</span>
  <span class="p">.</span><span class="n">m_base</span>               <span class="kt">resb</span> <span class="n">PyModuleDef_Base_size</span>
  <span class="p">.</span><span class="n">m_name</span>               <span class="kt">resq</span> <span class="mi">1</span>    <span class="c">; const char *</span>
  <span class="p">.</span><span class="n">m_doc</span>                <span class="kt">resq</span> <span class="mi">1</span>    <span class="c">; const char *</span>
  <span class="p">.</span><span class="n">m_size</span>               <span class="kt">resq</span> <span class="mi">1</span>    <span class="c">; Py_ssize_t</span>
  <span class="p">.</span><span class="n">m_methods</span>            <span class="kt">resq</span> <span class="mi">1</span>    <span class="c">; PyMethodDef *</span>
  <span class="p">.</span><span class="n">m_slots</span>              <span class="kt">resq</span> <span class="mi">1</span>    <span class="c">; struct PyModuleDef_Slot *</span>
  <span class="p">.</span><span class="n">m_traverse</span>           <span class="kt">resq</span> <span class="mi">1</span>    <span class="c">; traverseproc</span>
  <span class="p">.</span><span class="n">m_clear</span>              <span class="kt">resq</span> <span class="mi">1</span>    <span class="c">; inquiry</span>
  <span class="p">.</span><span class="n">m_free</span>               <span class="kt">resq</span> <span class="mi">1</span>    <span class="c">; freefunc</span>
<span class="n">ENDSTRUC</span></code></pre></figure>

<p>As you can easily guess, NASM generates the constants <code class="highlighter-rouge">PyObject_size</code> etc… automatically so that they can be used to reserve enough memory to hold the entire structure in the definition of other structures. This makes nesting quite easy to implement in NASM.</p>

<h2 id="local-and-global-functions">
<a id="local-and-global-functions" class="anchor" href="#local-and-global-functions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Local and Global Functions</h2>

<p>Finally we get to the actual code that will get executed by CPython when our module is loaded and initialised, and when the methods that it provides are called.</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="c">;; ---------------------------------------------------------------------------</span>
<span class="kr">SECTION</span>                 <span class="p">.</span><span class="n">text</span>
<span class="c">;; ---------------------------------------------------------------------------</span>

<span class="n">asm_sayit</span><span class="o">:</span> <span class="c">;; ----------------------------------------------------------------</span>
                        <span class="k">push</span>  <span class="n">rbp</span>
                        <span class="k">mov</span>   <span class="n">rbp</span><span class="p">,</span> <span class="n">rsp</span>

                        <span class="k">mov</span>   <span class="n">rax</span><span class="p">,</span> <span class="mi">1</span>                  <span class="c">; SYS_WRITE</span>
                        <span class="k">mov</span>   <span class="n">rdi</span><span class="p">,</span> <span class="mi">1</span>                  <span class="c">; STDOUT</span>
                        <span class="k">mov</span>   <span class="n">rsi</span><span class="p">,</span> <span class="n">l_sayit_msg</span>
                        <span class="k">mov</span>   <span class="n">rdx</span><span class="p">,</span> <span class="n">l_sayit_msg_len</span>
                        <span class="k">syscall</span>

                        <span class="k">mov</span>   <span class="n">rax</span><span class="p">,</span> <span class="n">Py_None</span>
                        <span class="k">inc</span>   <span class="n">QWORD</span> <span class="err">[</span><span class="n">rax</span> <span class="o">+</span> <span class="n">PyObject</span><span class="p">.</span><span class="n">ob_refcnt</span><span class="err">]</span>

                        <span class="k">pop</span>   <span class="n">rbp</span>
                        <span class="k">ret</span>
<span class="c">;; end asm_sayit</span>


<span class="n">PyInit_asm</span><span class="o">:</span> <span class="c">;; --------------------------------------------------------------</span>
                        <span class="k">push</span>  <span class="n">rbp</span>
                        <span class="k">mov</span>   <span class="n">rbp</span><span class="p">,</span> <span class="n">rsp</span>

                        <span class="k">mov</span>   <span class="n">rsi</span><span class="p">,</span> <span class="n">PYTHON_API_VERSION</span>
                        <span class="k">mov</span>   <span class="n">rdi</span><span class="p">,</span> <span class="n">l_asm_module</span>
                        <span class="k">call</span>  <span class="n">PyModule_Create2</span> <span class="n">WRT</span> <span class="p">..</span><span class="n">plt</span>

                        <span class="k">pop</span>   <span class="n">rbp</span>
                        <span class="k">ret</span>
<span class="c">;; end PyInit_asm</span></code></pre></figure>

<p>In fact, we have a total of two functions, one local and one global. The first one, <code class="highlighter-rouge">asm_sayit</code>, is the only method contained in our module. All it does is to write a string, <code class="highlighter-rouge">l_sayit_msg</code>, to standard output by invoking the <code class="highlighter-rouge">SYS_WRITE</code> system call. Perhaps the most interesting bit of this function is the code on lines 61-62. This is the idiom for any function that wishes to return <code class="highlighter-rouge">None</code> in Python. Recall that, in Python, <code class="highlighter-rouge">None</code> is an object instantiated by CPython. As such, our shared library needs to import it as an external symbol. This is why you will find the macro <code class="highlighter-rouge">PyNone</code> defined as</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="cp">%define</span> <span class="n">Py_None</span>               <span class="n">_Py_NoneStruct</span></code></pre></figure>

<p>together with the line</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="kr">EXTERN</span>    <span class="n">_Py_NoneStruct</span></code></pre></figure>

<p>in the <code class="highlighter-rouge">python.inc</code> file. This is equivalent to the two lines</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">PyAPI_DATA</span><span class="p">(</span><span class="n">PyObject</span><span class="p">)</span> <span class="n">_Py_NoneStruct</span><span class="p">;</span> <span class="cm">/* Don't use this directly */</span>
<span class="cp">#define Py_None (&amp;_Py_NoneStruct)</span></code></pre></figure>

<p>in the <code class="highlighter-rouge">object.h</code> header file, where the <code class="highlighter-rouge">None</code> object is defined. All of this explains line 61, but what about line 62? This has to do with <a href="https://docs.python.org/3/c-api/refcounting.html">Reference Counting</a>. In a nutshell, every object created in Python comes with a counter that keeps track of all the references attached to it. When the counter gets down to 0, the object can be de-allocated from memory and resources freed for other objects to use. This is how Python, which heavily relies on <code class="highlighter-rouge">malloc</code>, can keep memory leaks at bait. It is therefore very important to properly maintain reference counts in Python extensions. As <code class="highlighter-rouge">None</code> is a Python object like any others, when we return a reference to it, we have to bump its reference count. In C, this is conveniently done with the <code class="highlighter-rouge">Py_INCREF</code> macro. Its definition is in the <code class="highlighter-rouge">object.h</code> and, as it is easy to guess, it just increases the <code class="highlighter-rouge">ob_refcnt</code> field of the <code class="highlighter-rouge">PyObject</code> structure. This is precisely what we do on line 62.</p>

<blockquote>
  <p><strong>Stack Frames Matter!</strong> You might be wondering why we are taking care of creating a stack frame on function entry, and cleaning up after ourself on leave. The reason is a pretty obvious one: we don’t know what code will call ours, so it is safe to make sure that stack alignment is preserved across calls by doing what every function is expected to do. When I was lying down the code for this post, I was getting a SIGSEGV exception, and the debugger revealed that the instruction <code class="highlighter-rouge">movaps</code> was trying to store the value of the <code class="highlighter-rouge">xmm0</code> register on a memory location that was not a multiple of 16. The problem was solved by the extra 8 bytes from <code class="highlighter-rouge">push rbp</code>.</p>
</blockquote>

<p>The second and last function is our global exported symbol <code class="highlighter-rouge">PyInit_asm</code>. It gets called by CPython as soon as we <code class="highlighter-rouge">import</code> the module with <code class="highlighter-rouge">import asm</code>. In this simple case, we don’t have to do much here. In fact, all we have to do is call a standard CPython function and pass it the instance of <code class="highlighter-rouge">PyModuleDef</code> allocated at <code class="highlighter-rouge">l_asm_module</code>. As we have briefly seen, this contains all the information about our module, from the documentation to the list of methods.</p>

<p>Now, if you have read through the official documentation on how to extend Python with C, you might be wondering why we are calling <code class="highlighter-rouge">PyModule_Create2</code> instead of <code class="highlighter-rouge">PyModule_Create</code> (is there a typo?), and why we are passing it two arguments instead of one. If you are starting to smell a C macro, then you are correct! Long story short, <code class="highlighter-rouge">PyModule_Create</code> is a macro defined as</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define PyModule_Create(module) PyModule_Create2(module, PYTHON_API_VERSION)</span></code></pre></figure>

<p>with <code class="highlighter-rouge">PYTHON_API_VERSION</code> defined as the literal 1013. So the actual function to call is indeed <code class="highlighter-rouge">PyModule_Create2</code>, and it takes two arguments.</p>

<blockquote>
  <p>Did you notice that weird <code class="highlighter-rouge">WRT ..plt</code>? Remember the discussion about ensuring position-independent code? Since we have no clue of where the <code class="highlighter-rouge">PyModule_Create2</code> function resides in memory, we have to rely on some sort of indirection. This is provided by the so-called <em>Procedure Linkage Table</em>, or <em>PLT</em> for short, which is some code that is part of our shared library. When we call <code class="highlighter-rouge">PyModule_Create2 WRT ..plt</code>, we are jumping to the PLT section of our object file in memory, which contains the necessary code to make the actual jump to the function that we want to call.</p>
</blockquote>

<h1 id="installation">
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation</h1>

<p>Once our assembly code is ready, it needs to be assembled and linked into a shared object file. We will now see how to perform these steps, and how to test and install our Python extension.</p>

<h2 id="assembling-and-linking">
<a id="assembling-and-linking" class="anchor" href="#assembling-and-linking" aria-hidden="true"><span class="octicon octicon-link"></span></a>Assembling and Linking</h2>

<p>Once the code is ready, it needs to be assembled and linked into the final shared object file. The NASM assembler is invoked with minimal arguments as</p>

<div class="terminal"><div class="terminal-body flex-container flex-row">
<div class="pad-right"><pre>$ </pre></div>
<div><pre>
nasm -f elf64 -o asm/asm.o asm/asm.asm
</pre></div>
</div></div>

<p>This creates an intermediate object file <code class="highlighter-rouge">asm.o</code>. To create the final shared object file, we use the GNU linker with the following arguments</p>

<div class="terminal"><div class="terminal-body flex-container flex-row">
<div class="pad-right"><pre>$ </pre></div>
<div><pre>
ld -shared -o asm/asm.so asm/asm.o -I/lib64/ld-linux-x86-64.so.2
</pre></div>
</div></div>

<p>Note the use of the <code class="highlighter-rouge">-shared</code> switch, which instructs the linker to create a shared object file.</p>

<h2 id="how-to-test-the-module">
<a id="how-to-test-the-module" class="anchor" href="#how-to-test-the-module" aria-hidden="true"><span class="octicon octicon-link"></span></a>How to Test the Module</h2>

<p>The first thing that you might want to do is to manually test that the shared object file works fine with Python. For CPython to be able to find the module, we need to ensure that its location is included in the search path. One way is to add it to the <code class="highlighter-rouge">PYTHONPATH</code> environment variable. For example, from within the project folder, we can launch Python with</p>

<div class="terminal"><div class="terminal-body flex-container flex-row">
<div class="pad-right"><pre>$ </pre></div>
<div><pre>
PYTHONPATH=./asm python3
</pre></div>
</div></div>

<p>and from the interactive session we should be able to import the module with</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">asm</span>
<span class="o">&gt;&gt;&gt;</span></code></pre></figure>

<p>Alternatively, we can add the search path to <code class="highlighter-rouge">sys.path</code> with these few lines of Python code</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">sys</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">"./asm"</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">asm</span>
<span class="o">&gt;&gt;&gt;</span></code></pre></figure>

<p>Once we have successfully imported our module in Python, we can test that its method <code class="highlighter-rouge">sayit</code> works as expected</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="n">asm</span><span class="o">.</span><span class="n">sayit</span><span class="o">.</span><span class="n">__doc__</span>
<span class="s">'This method has something important to say.'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">asm</span><span class="o">.</span><span class="n">sayit</span><span class="p">()</span>
<span class="n">Assembly</span> <span class="ow">is</span> <span class="n">great</span> <span class="n">fun</span><span class="err">!</span> <span class="p">:)</span>
<span class="o">&gt;&gt;&gt;</span></code></pre></figure>

<p>I hope that you would agree :).</p>

<h2 id="distributing-the-module">
<a id="distributing-the-module" class="anchor" href="#distributing-the-module" aria-hidden="true"><span class="octicon octicon-link"></span></a>Distributing the Module</h2>

<p>The simplicity of our sample module wouldn’t justify the use of <code class="highlighter-rouge">setuptools</code> for distribution. In this case, a simple, old-fashioned Makefile is the simplest solution to go for. Even for larger projects, you would probably still delegate the build job of your code to a Makefile anyway, which would then get called from your <code class="highlighter-rouge">setup.py</code> at some phase, perhaps during <code class="highlighter-rouge">build</code>. However, the recommended standard is that you build <em>wheels</em> instead of <em>eggs</em>, and the requirement is that you provide pre-built binaries with your package.</p>

<p>This being said, let’s see how to distribute the module. As we have seen in the previous section, the shared object needs to resides in one of the Python search paths. The easiest way to find out what these paths are on the platform that you are targeting is to launch the Python interpreter and print the value of <code class="highlighter-rouge">sys.path</code>. On my platform, I get the following output</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">Python</span> <span class="mf">3.6.3</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Oct</span>  <span class="mi">3</span> <span class="mi">2017</span><span class="p">,</span> <span class="mi">21</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">48</span><span class="p">)</span>
<span class="p">[</span><span class="n">GCC</span> <span class="mf">7.2.0</span><span class="p">]</span> <span class="n">on</span> <span class="n">linux</span>
<span class="n">Type</span> <span class="s">"help"</span><span class="p">,</span> <span class="s">"copyright"</span><span class="p">,</span> <span class="s">"credits"</span> <span class="ow">or</span> <span class="s">"license"</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">sys</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span>
<span class="p">[</span><span class="s">''</span><span class="p">,</span> <span class="s">'/usr/lib/python36.zip'</span><span class="p">,</span> <span class="s">'/usr/lib/python3.6'</span><span class="p">,</span> <span class="s">'/usr/lib/python3.6/lib-dynload'</span><span class="p">,</span> <span class="s">'/usr/local/lib/python3.6/dist-packages'</span><span class="p">,</span> <span class="s">'/usr/lib/python3/dist-packages'</span><span class="p">,</span> <span class="s">'/usr/lib/python3.6/dist-packages'</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span></code></pre></figure>

<p>The Makefile could then contain the following line inside the <code class="highlighter-rouge">install</code> rule:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">install</span>: default
	<span class="nb">cp </span>asm/asm.so /usr/lib/python<span class="k">${</span><span class="nv">PYTHON_TARGET</span><span class="k">}</span>/asm.so</code></pre></figure>

<p>with the environment variable <code class="highlighter-rouge">PYTHON_TARGET</code> set to <code class="highlighter-rouge">3.6</code>.</p>

<p>To automate the building and testing process of the module, we could use Docker to build an image out of the target platform and trigger a build, and perhaps execute some unit tests too. A simple Dockerfile that does the minimum work to build and test would look something like the following</p>

<figure class="highlight"><pre><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s">  ubuntu:latest</span>
<span class="k">USER</span><span class="s">  root</span>
<span class="k">ADD</span><span class="s">   . asm</span>
<span class="k">RUN   </span>apt-get update              <span class="o">&amp;&amp;</span><span class="se">\
</span>      apt-get <span class="nb">install</span> <span class="nt">-y</span>            <span class="se">\
</span>        nasm                        <span class="se">\
</span>        python3-pytest              <span class="se">\
</span>        build-essential
<span class="k">ENV</span><span class="s">   PYTHON_TARGET=3.5</span>
<span class="k">RUN   </span><span class="nb">cd </span>asm                      <span class="o">&amp;&amp;</span><span class="se">\
</span>      make                        <span class="o">&amp;&amp;</span><span class="se">\
</span>      make <span class="nb">install</span>                <span class="o">&amp;&amp;</span><span class="se">\
</span>      python3 <span class="nt">-m</span> pytest <span class="nt">-s</span></code></pre></figure>

<p>As you can see, we are targeting the latest stable version of Ubuntu, which comes with <code class="highlighter-rouge">python3.5</code>. We make sure we install all the required dependencies, the assembler and the standard build tools, along with <code class="highlighter-rouge">python3-pytest</code> to perform unit testing once our module builds successfully.</p>

<p>The bare minimum that we can test is that the import of the module works fine and that we can call its method. So a possible <code class="highlighter-rouge">test_asm.py</code> test script would look like</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">asm</span>


<span class="k">def</span> <span class="nf">test_asm</span><span class="p">():</span>
    <span class="n">asm</span><span class="o">.</span><span class="n">sayit</span><span class="p">()</span></code></pre></figure>

<h1 id="conclusions">
<a id="conclusions" class="anchor" href="#conclusions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusions</h1>

<p>Whilst I appreciate that the cases where you’d want to seriously consider extending Python with Assembly code are rare, it is undoubtedly the case that, if you enjoy experimenting with code, this could be a fun and instructing experience. In my case, this has forced me to go look into the CPython header files, which I probably wouldn’t have if I were using C. I now know more about the internal workings of Python and a clearer idea of how CPython is structured.</p>

<p>As always, I hope you have enjoyed the read. Happy Assembly coding! :)</p>

    </div>

    <div class="comments">
  <h1>Comments</h1>

  
    
    
    <ul class="comment-list">
      
        
        
      
    </ul>
  

  <h2 id="comment-hdr">Leave a comment</h2>
  <script src="https://p403n1x87.github.io//js/comments.js"></script>

<form id     = "post-comment"
      class  = "comment"
      method = "post"
      action = "">

  <input type        = "text"
         name        = "fields[name]"
         id          = "name"
         placeholder = "Name"/>

  <input type        = "text"
         name        = "fields[email]"
         placeholder = "E-mail address (optional; stored hashed for privacy)"/>

  <textarea name        = "fields[comment]"
            id          = "comment"
            rows        = "5"
            placeholder = "Write your comment here. You can use markdown and LaTeX (use $...$ to inline)"></textarea>

  <button type  = "button"
          class = "flat_button"
          id    = "btn-submit-comment"
          onClick="submitComment();">
    SUBMIT FOR APPROVAL
  </button>


  <!-- Hidden fields -->

   <input type  = "hidden"
          name  = "fields[pic]"
          value = "asm_python"/>

    <input type  = "hidden"
           id    = "timestamp"
           name  = "fields[timestamp]"
           value = "1557091937"/>

    <input type  = "hidden"
           id    = "parent"
           name  = "fields[parent]"
           value = "0"/>

</form>

<div id="snackbar"></div>


</div>

  </div>
</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">The Hub of Heliopolis</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>The Hub of Heliopolis is maintained by Gabriele N. Tornetta</li>
          <li><a href="mailto:phoenix1987@gmail.com">phoenix1987@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <i class="fa fa-github" aria-hidden="true"></i>&nbsp;<a href="https://github.com/P403n1x87"><span class="username">P403n1x87</span></a>

          </li>
          

          

          <li>
            <i class="fa fa-rss-square" aria-hidden="true"></i>&nbsp;<a href="/feed.xml">Subscribe</a>
          </li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>The Hub of Heliopolis is the <i>tech bay</i> of <a href="http://thenestofheliopolis.blogspot.co.uk/">The Nest of Heliopolis</a>. It is the home of all my <i>encounters</i> with technology that I consider worth sharing with the World.
</p>
      </div>
    </div>

    <div class="footer-copyright">
      Copyright (C) 2017 Gabriele N. Tornetta. All rights reserved.
    </div>

  </div>

</footer>


    
      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-104560783-1', 'auto');
  ga('send', 'pageview');

</script>

    

    <script src="https://use.fontawesome.com/8c7b940d60.js"></script>

    <!-- MathJax support -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>


  </body>

</html>
