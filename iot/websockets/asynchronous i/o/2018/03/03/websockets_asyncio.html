<!DOCTYPE html>
<html>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>IoT with WebSockets and Python&#39;s AsyncIO.</title>
  <meta name="description" content="After [a gentle introduction to the concept of IoT]({{ site.baseurl }}{% post_url 2017-07-31-intro-to-iot %}) and what it entails, we take a dive into WebSoc...">
  <meta name="theme-color" content="#100808" />

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://p403n1x87.github.io//iot/websockets/asynchronous%20i/o/2018/03/03/websockets_asyncio.html">
  <link rel="alternate" type="application/rss+xml" title="The Hub of Heliopolis" href="https://p403n1x87.github.io//feed.xml">
</head>


  <body>

    <header class="site-header">
  <div class="site-title">
    ~# <a href="/">the-<strong>hub</strong>-of-heliopolis</a><span class="blinking-cursor">&block;</span>
  </div>
  <div class="wrapper">
    <nav class="site-nav">
      <div class="trigger">
        
          
        
          
          <a class="page-link" href="/">Posts</a>
          
        
          
        
          
          <a class="page-link" href="/about/">About</a>
          
        
      </div>
    </nav>

  </div>
</header>


    <div class="page-content">
      <div class="wrapper">
        <h1 class="post-title" itemprop="name headline">IoT with WebSockets and Python's AsyncIO.</h1>

<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="sidepane post-header">
    
    <div class="post-info">
  <div class="post-detail"><i class="fa fa-calendar-plus-o" aria-hidden="true"></i>&nbsp;2018 Mar 3</div>
  <div class="post-detail"><i class="fa fa-clock-o" aria-hidden="true"></i>&nbsp;<span class="reading-time" title="Estimated read time">
  
  
    a 32 minute read
  
</span>
</div>
  <div class="flex-container flex-row post-detail">
  <div><i class="fa fa-archive" aria-hidden="true"></i></div>&nbsp;
  <div><span class="category">IoT</span><span class="category">WebSockets</span><span class="category">Asynchronous I/O</span></div>
</div>
<div class="flex-container flex-row post-detail">
  <div><i class="fa fa-tags" aria-hidden="true"></i></div>&nbsp;
  <div class="flex-container flex-row flex-wrap"><span class="tag">IoT</span><span class="tag">Python</span><span class="tag">Android</span><span class="tag">WebSockets</span><span class="tag">asyncio</span></div>
</div>

  
    <div class="post-detail"><i class="fa fa-github" aria-hidden="true"></i>&nbsp;<a href="https://github.com/P403n1x87/iot/tree/master/gravity_led">P403n1x87/iot/gravity_led</a></div>
  
</div>


    <div class="toc">
      <div class="heading">Table of Contents</div>
      <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#introduction">Introduction</a></li>
<li class="toc-entry toc-h1"><a href="#connecting-devices-over-a-network-websockets">Connecting Devices over a Network: WebSockets</a>
<ul>
<li class="toc-entry toc-h2"><a href="#coroutines">Coroutines</a></li>
<li class="toc-entry toc-h2"><a href="#the-asyncio-module">The asyncio module</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#setting-things-up">Setting Things Up</a>
<ul>
<li class="toc-entry toc-h2"><a href="#the-circuitry">The Circuitry</a></li>
<li class="toc-entry toc-h2"><a href="#the-server-code">The Server Code</a></li>
<li class="toc-entry toc-h2"><a href="#the-client-code">The Client Code</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#conclusions">Conclusions</a></li>
</ul>
    </div>

  </header>

  <div class="post-text">

    <div class="post-excerpt">
      <p>After <a href="{{ site.baseurl }}{% post_url 2017-07-31-intro-to-iot %}">a gentle introduction to the concept of IoT</a> and what it entails, we take a dive into WebSockets and Asynchronous I/O in Python to explore other ways of controlling devices over a network. This post uses a simple two LED circuit to introduce WebSockets, and how to use them in Python together with the <code class="highlighter-rouge">asyncio</code> module.</p>

    </div>

    <div class="post-content" itemprop="articleBody">
      <h1 id="introduction">
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h1>

<p>In this post, we will get back to the topic of IoT to introduce two new
technologies by example: <strong>WebSockets</strong> and <strong>Asynchronous I/O</strong> in Python. The project that will allow us to explore them is a simple system of two LEDs that we will control with the gravity sensor of an Android device via a Raspberry Pi over a network.</p>

<p>The post is divided into two parts. The first one is theoretical in nature and will cover the essential technical details of the two main subjects, that is <em>WebSockets</em> and Python’s <em>asyncio</em>. In the second part we will have a look at the circuit that we are going to control over the network and discuss the server and client code.</p>

<p>But before we dive into the study of the topics of this post, it is perhaps best to first have a high level view of how all the pieces fit together, thus motivating the choices of technologies mentioned above. The idea of the project stems from the following scenario: suppose you want to build a device that can be controlled over the network, e.g. an hand-held device like a phone. As we have seen in <a href="/raspberry%20pi/iot/2017/07/31/intro-to-iot.html">a previous post</a>, one way of achieving this is by using a single-board computer like a Raspberry Pi and control it via a web server.</p>

<p>Now, what if you wanted more control over the connection method to the device, and perhaps a bi-directional channel to let data from, e.g. sensors on the device, to flow upstream to the controlling device? An elegant way of achieving this goal these days is with <strong>WebSockets</strong>, which allow (full) duplex communication between pairs of connected devices. So, for instance, we could have a WebSocket server running on a Raspberry Pi, and have a native application on an Android device to run a WebSocket client. Control commands can then flow from the Android device to the single-board computer, while the server can feed data from any sensors that the device is equipped with back to the client, with just a single connection.</p>

<p>The code samples that we will look at towards the end of the post implement a Python WebSocket server that will run on, e.g., a Raspberry Pi, and a native Android application that will act as a WebSocket client to control a pair of LEDs mounted on a breadboard. The data that we will transfer from the Android device to our circuit is coming from a gravity sensor, so that when we twist the hand-held device clockwise or anti-clockwise, a different LED will turn on. Furthermore, the brightness will depend on how much the device is tilted.</p>

<p>So, read on to find out more!</p>

<h1 id="connecting-devices-over-a-network-websockets">
<a id="connecting-devices-over-a-network-websockets" class="anchor" href="#connecting-devices-over-a-network-websockets" aria-hidden="true"><span class="octicon octicon-link"></span></a>Connecting Devices over a Network: WebSockets</h1>

<p>In <a href="(/raspberry%20pi/iot/2017/07/31/intro-to-iot.html)">A Gentle Introduction to IoT</a>, we saw how to control a single LED over a network by running a web server hosting the controlling web application. This was a simple web page that displayed a button that not only showed the current state of the LED, but allowed to control it by turning it on or off. All we needed to do was to point a web browser to the web server running on the Raspberry Pi and play around with the only web page on it.</p>

<p>There might be situations where we are not happy with a web server, but we actually want more control over the way devices connect with each other. In a simple client-server relationship, surely TCP/IP sockets spring to mind, but what if we want to allow for data to flow in both directions?</p>

<p>Contrary to ordinary sockets, WebSockets offer a full-duplex communication channel over a single TCP connection. They are compatible with the HTTP protocol, but make use of their own protocol (the <em>WebSocket</em> protocol), which is switched to by including an HTTP Upgrade header in the HTTP handshake. By default, they are supposed to operate on the standard HTTP ports (80 for HTTP and 443 for secured HTTP), but a different one can be used for custom use, as we will see in our example. The advantage over any other solutions is that WebSockets have been designed to allow for fast bi-directional communication between client and server via an TCP connection that is kept open until manually closed (or dropped for other reasons), but without the overheads of HTTP headers.</p>

<p>By design, WebSockets are then the perfect tool for exchanging short <em>messages</em> between devices. As to what kind of messages we can send back and forth, we will see that we can either send <em>text</em> messages, or raw <em>binary</em> data, by either operating the WebSocket with <em>text</em> or <em>binary</em> frames.</p>

<p>Having justified the use of WebSockets for our project, we now have to motivate the use of the other mentioned technology: <code class="highlighter-rouge">asyncio</code>.</p>

<p>Like in <a href="(/raspberry%20pi/iot/2017/07/31/intro-to-iot.html)">A Gentle Introduction to IoT</a>, the choice of Python is motivated by the use of the Raspberry Pi. In Python, WebSocket support is provided by the <a href="https://pypi.python.org/pypi/websockets"><code class="highlighter-rouge">websockets</code></a> module, which is built on top of <a href="https://docs.python.org/3/library/asyncio.html"><code class="highlighter-rouge">asyncio</code></a>.</p>

<p>Here is where we encounter the first constraint though, since <code class="highlighter-rouge">asyncio</code> was introduced in Python 3.4. We then have to ensure that we are using a version of Python greater than or at least equal to 3.4. But our coding can also vary based on whether we are using Python 3.5 and later. That is because this version of Python introduces the <code class="highlighter-rouge">async</code> and <code class="highlighter-rouge">await</code> syntax for natively defining coroutines (<a href="https://www.python.org/dev/peps/pep-0492/">PEP 492</a>).</p>

<p>In the last part of this post we will have a look at Python code samples written with the standard <code class="highlighter-rouge">asyncio</code> syntax, as well as the new one introduced by PEP 492. For now, we shall have a quick overview of the new features that are brought to Python 3 by the <code class="highlighter-rouge">asyncio</code> module to better familiarise with it and its usage.</p>

<h2 id="coroutines">
<a id="coroutines" class="anchor" href="#coroutines" aria-hidden="true"><span class="octicon octicon-link"></span></a>Coroutines</h2>

<p>I believe that the best way to understand <code class="highlighter-rouge">asyncio</code> is to first look at the basic concepts involved and recall the notion of <code class="highlighter-rouge">coroutine</code>. In Python we have the concept of <em>Generators</em> since version 2.2. Generators look and feel like normal functions, but rather than <em>returning</em> a value, they <em>yield</em> one, and are normally used in loops to provide iterators.</p>

<p>The typical scenario where you’d want to opt for a generator rather than a function is when you have to keep track of some state in between the different values returned. A simple example is a generator that generates the first $n$ Fibonacci numbers:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>

    <span class="k">yield</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span>

    <span class="k">yield</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span>

    <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">+</span> <span class="n">a1</span>
        <span class="k">yield</span> <span class="n">a2</span>
        <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span> <span class="o">=</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span></code></pre></figure>

<p>If $n=0$, the generator doesn’t yield any number and we can then return. When $n=1$, the generator must yield the first Fibonacci number only, which is 0, and so on. The difference between <code class="highlighter-rouge">return</code> and <code class="highlighter-rouge">yield</code> is that the former terminates the iteration, while the latter allows it to continue. To better understand what is going on here, observe that a call to <code class="highlighter-rouge">fibonacci</code>, like <code class="highlighter-rouge">f = fibonacci(10)</code> doesn’t return a Fibonacci number (you might at first expect this to return the first Fibonacci number), but a <em>generator object</em> instead, that is, something that we can use with a <code class="highlighter-rouge">for</code> loop, or any function that expects an iterable object, like <code class="highlighter-rouge">sum</code>. The first two Fibonacci numbers can then be generated with</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">f</span> <span class="o">=</span> <span class="n">fibonacci</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
<span class="c1"># Expected output
# &lt;generator object fibonacci at 0x7f2e0940baf0&gt;
# 0
# 1</span></code></pre></figure>

<p>but if we now try to print yet another Fibonacci number, we get a <code class="highlighter-rouge">StopIteration</code> exception, which signals that the generator has returned and that there are no more values to be generated:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
<span class="c1"># Expected output
# Traceback (most recent call last):
#   File "&lt;stdin&gt;", line 5, in &lt;module&gt;
#     print(next(f))
#
# StopIteration</span></code></pre></figure>

<p>The following code snippet illustrates the use of a generator with a <code class="highlighter-rouge">for</code> loop</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">test_cases</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">test_cases</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Test case: n = {}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">t</span><span class="p">):</span> <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></code></pre></figure>

<p>I am omitting the expected output to avoid cluttering the page, but it should be quite clear what the above code is supposed to do. To produce a more compact result we can do something like</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">sfibonacci</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="p">):</span> <span class="k">yield</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">test_cases</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Test case: n = {}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sfibonacci</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span>

<span class="c1"># Expected output:
#
# Test case: n = 0
#
# Test case: n = 1
# 0
# Test case: n = 2
# 0 1
# Test case: n = 3
# 0 1 1
# Test case: n = 10
# 0 1 1 2 3 5 8 13 21 34
# Test case: n = 20
# 0 1 1 2 3 5 8 13 21 34 55 89 144 233 377 610 987 1597 2584 4181</span></code></pre></figure>

<p>which also shows how to construct a generator out of another generator.</p>

<p>From the above example we deduce that the <code class="highlighter-rouge">yield</code> keyword is generating a value while also “<em>pausing</em>” the execution of the function, until another value is requested from it. In this case, the execution resumes from the instruction that comes soon after the <code class="highlighter-rouge">yield</code>, with all the values of local variables (the <em>state</em>) preserved.</p>

<p><em>Generators</em> are also known as <em>semicoroutine</em>, and this leads us to talk about <em>coroutines</em>. This is a more general concept, because it encompasses those code elements that not only pass a value to the caller, but also receive and process a value passed to them by another code element (e.g. a generator, or another coroutine). This definition looks a bit circular, and this is due to the fact that, with coroutines, the relation is not of caller-callee, but symmetric. In more concrete terms, we are talking about functions that can retain a state in between invocations, and that can call to other functions, suspending and resuming execution from certain points of the code.</p>

<p>Starting with Python 2.5, coroutines have become an integral part of the language. They can be easily constructed with <code class="highlighter-rouge">yield</code>, which has been turned into an <em>expression</em>. The value <code class="highlighter-rouge">yields</code> evaluates to is passed to the coroutine with a call to <code class="highlighter-rouge">send</code> on the generator, like so</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">coroutine</span><span class="p">():</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="k">yield</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"#{} : {}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>

<span class="n">coro</span> <span class="o">=</span> <span class="n">coroutine</span><span class="p">()</span>
<span class="n">coro</span><span class="o">.</span><span class="nb">next</span><span class="p">()</span>
<span class="n">coro</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">)</span>
<span class="n">coro</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"World"</span><span class="p">)</span>
<span class="c1"># Expected output
# #1 : Hello
# #2 : World</span></code></pre></figure>

<p>If you look to code like the above for the first time, you might be wondering why I have included a call to <code class="highlighter-rouge">next</code>. Remember from our discussion on generators that, contrary to normal functions, a call to <code class="highlighter-rouge">coroutine</code> returns a generator object and not the first generated value. After creation, a coroutine needs to be <em>primed</em>, that is it needs to be started so that it can execute its code until the first occurrence of the <code class="highlighter-rouge">yield</code> expression. The coroutine then halts and waits for values to be sent to it. In Python, there are two equivalent ways of priming a coroutine: either call <code class="highlighter-rouge">next</code>, as we have done in the code above, or send it a <code class="highlighter-rouge">None</code> with <code class="highlighter-rouge">coro.send(None)</code>.</p>

<blockquote>
  <p>Since it is quite easy to forget to prime a coroutine, a good idea is to define a decorator, e.g. <code class="highlighter-rouge">@coroutine</code> that creates, primes and returns a coroutine.</p>
</blockquote>

<p>If you want to know more about coroutines, I recommend that you have a look at David Beazley’s <a href="http://www.dabeaz.com/coroutines/">A Curious Course on Coroutines and Concurrency</a>. Here, I have just stated the essential details that we are going to need for our project. These should be enough to convince you that, with coroutines in Python we can implement single-threaded concurrency, which offer an ideal ground for asynchronous I/O operations, without the overhead of many context switches between different threads.</p>

<h2 id="the-asyncio-module">
<a id="the-asyncio-module" class="anchor" href="#the-asyncio-module" aria-hidden="true"><span class="octicon octicon-link"></span></a>The <code class="highlighter-rouge">asyncio</code> module</h2>

<p>If you have ever done any sort of I/O before, like reading from/writing to a file, or creating a socket and waiting for a connection etc… you will surely know that most of the I/O operations are blocking. For example, if you are trying to read from a file descriptor by making a <code class="highlighter-rouge">SYS_READ</code> system call, your code will hand control over to the OS until your request can be honoured. The normal execution flow then resumes.</p>

<p>The problem with this wait is that, in most cases, you don’t know when there will be enough data available from the file descriptor to read. Your application then halts while it might be doing something useful instead.</p>

<p>The typical workaround is to poll the file descriptor periodically, and only read from it when data is actually available. As you can easily imagine, the solutions come in different patterns, and every time you have to deal with this there is some boilerplate code that you would have to write. This amounts to writing your event loop to cycle through your tasks, which include I/O polling. Wouldn’t it be nice if we were provided with such boilerplate code encapsulated in a module that we can use whenever we need to perform asynchronous I/O operations?</p>

<p>This must be what the people behind <code class="highlighter-rouge">asyncio</code> must have thought, and that’s why the essential element that this Python module offers is an <strong>event loop</strong>. This is designed to register and schedule <strong>Tasks</strong> which, with just a few words, can be described as <em>objects decorating coroutines</em> (hence, in practice, they are coroutines). Some of these tasks might involve I/O operations, and some of these operations might be blocking. By continuously polling for the I/O status of file descriptors, sockets etc…, <code class="highlighter-rouge">asyncio</code> allows you to write single-threaded concurrent code that performs I/O.</p>

<p>In this post, we are interested in working with WebSockets, as as an example of what we have just seen we can play around with some WebSocket servers and clients. In Python, we can make use of the <code class="highlighter-rouge">websockets</code> modules, which builds its functionalities on top of <code class="highlighter-rouge">asyncio</code>. The <a href="https://pypi.python.org/pypi/websockets">Getting Started</a> page on PyPI shows how simple it is to create a a WebSocket client, and an echo server to test it. The following examples are based on them, but with just some slight modifications, and a twist: the client sends a string read from STDIN and the echo server reverses it.</p>

<p>So here is the server code</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/env python3
</span>
<span class="c1"># Echo server. Will reverse everything we throw at it.
</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">websockets</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">websocket</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">websockets</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span><span class="n">echo</span><span class="p">,</span> <span class="s">'localhost'</span><span class="p">,</span> <span class="mi">8765</span><span class="p">))</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span></code></pre></figure>

<p>and here is the client code</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/env python3
</span>
<span class="c1"># Client. Sends stuff from STDIN to the server.
</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">websockets</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">websockets</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span> <span class="k">as</span> <span class="n">websocket</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"Hello world!"</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">websocket</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">input</span><span class="p">())</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">hello</span><span class="p">(</span><span class="s">'ws://localhost:8765'</span><span class="p">))</span></code></pre></figure>

<p>And that’s where we make our first encounter with the new <code class="highlighter-rouge">async</code>/<code class="highlighter-rouge">await</code> keywords, introduced by the already cited PEP 492. The new syntax <code class="highlighter-rouge">async def</code> is used to declare a <em>native coroutine</em> in Python 3.5 and later versions. Perhaps more interesting are <code class="highlighter-rouge">async with</code> and <code class="highlighter-rouge">async for</code>. The former introduces native asynchronous context managers for classes that define the new magic methods <code class="highlighter-rouge">__aenter__</code> and <code class="highlighter-rouge">__aexit__</code>, but apart from this, its usage is analogous to the synchronous counterpart <code class="highlighter-rouge">with</code>. The new syntax <code class="highlighter-rouge">async for</code> is used to consume asynchronous iterable, i.e. instances of classes that implement the <code class="highlighter-rouge">__aiter__</code> magic method. When the <code class="highlighter-rouge">await</code> keyword is on its own, it defines an expression that execute the coroutine it appears in to execute the one passed as its argument until it completes. In the case of the code above, we just wait for the <code class="highlighter-rouge">websocket</code> object to complete the task of sending the data.</p>

<p>After the above discussion, the code for the client application should be quite clear. The first call to <code class="highlighter-rouge">websocket.send</code> is used to <em>prime</em> the socket, so that <code class="highlighter-rouge">async for message in websocket</code> won’t hang indefinitely, waiting for something to show up on the socket’s reading end.</p>

<p>Before we look at how to rewrite the above code snippets for Python 3.4, where we do not have native coroutines, I would like to briefly comment on the last two lines of code of the server application. The first time I came across that code, they gave me a bit of thinking as to why we need to call <code class="highlighter-rouge">run_until_complete</code> and <code class="highlighter-rouge">run_forever</code>. Wouldn’t the former alone suffice? If you recall our discussion about blocking I/O operations and the necessity of constantly polling in order not to halt the execution of our application, you realise that the call to <code class="highlighter-rouge">run_until_complete</code> will register the socket with the I/O polling task. Hence, apart from this task, we have nothing else running, and if we do not start the event loop, the newly created socket won’t be checked and the application simply terminates. The last line is there to ensure that we keep monitoring the socket for new incoming connections. When a client connects, a new task is scheduled to serve the connection with the passed handler, which must be a coroutine. This can be verified by peeking at the source code of both <a href="https://github.com/python/cpython/tree/a19fb3c6aaa7632410d1d9dcb395d7101d124da4/Lib/asyncio"><code class="highlighter-rouge">asyncio</code></a> and <a href="https://github.com/aaugustin/websockets"><code class="highlighter-rouge">websockets</code></a>.</p>

<p>And now to the Python 3.4 version of the above code snippets. There are a few rule of thumb that we can use to convert from 3.5 and later to 3.4, where we don’t have <code class="highlighter-rouge">await</code> and <code class="highlighter-rouge">async</code>. The first is the use of the decorator <code class="highlighter-rouge">@asyncio.coroutine</code> instead of <code class="highlighter-rouge">async def</code>. The situation is a bit more complicated for <code class="highlighter-rouge">async with</code>, which requires a replacement for <code class="highlighter-rouge">await</code>, which is <code class="highlighter-rouge">yield from</code>. The latter is substantially equivalent to</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">foo</span><span class="p">():</span> <span class="k">yield</span> <span class="n">a</span>    <span class="c1"># Same as: yield from foo()</span></code></pre></figure>

<p>With this in mind, <code class="highlighter-rouge">async with</code> can be coded with a more traditional <code class="highlighter-rouge">try ... finally</code> block as</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># async with coro() as foo:
#     # &lt;code&gt;
#     pass
</span><span class="n">foo</span> <span class="o">=</span> <span class="k">yield</span> <span class="k">from</span> <span class="n">coro</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># &lt;code&gt;
</span>    <span class="k">pass</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="c1"># Whatever coro().__aexit__() would have done.</span></code></pre></figure>

<p>The <code class="highlighter-rouge">async for</code> loop would translate to something like the following</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># async for foo in bar():
#     # &lt;code&gt;
#     pass
</span><span class="k">try</span><span class="p">:</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="k">yield</span> <span class="k">from</span> <span class="n">bar</span><span class="p">()</span><span class="o">.</span><span class="n">__anext__</span><span class="p">()</span>
        <span class="c1"># &lt;code&gt;
</span><span class="k">except</span> <span class="nb">StopAsyncIteration</span><span class="p">:</span>
    <span class="k">return</span></code></pre></figure>

<p>This coding is not strict, since you could, or you might have to replace the code of <code class="highlighter-rouge">bar().__anext__()</code> with the actual coding inside this coroutine. This is the case for the code that we are about to see, in which we perform the above translations. The server code for Python 3.4 is the following</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/env python3
</span>
<span class="c1"># Echo server. Will reverse everything we throw at it.
# For Python 3.4
</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">websockets</span>

<span class="o">@</span><span class="n">asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="n">websocket</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="k">yield</span> <span class="k">from</span> <span class="n">websocket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="k">yield</span> <span class="k">from</span> <span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">websockets</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span><span class="n">echo</span><span class="p">,</span> <span class="s">'localhost'</span><span class="p">,</span> <span class="mi">8765</span><span class="p">))</span>
<span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span></code></pre></figure>

<p>while the client code now looks like this</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/env python3
</span>
<span class="c1"># Client. Sends stuff from STDIN to the server.
# For Python 3.4
</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">websockets</span>

<span class="o">@</span><span class="n">asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
    <span class="n">websocket</span> <span class="o">=</span> <span class="k">yield</span> <span class="k">from</span> <span class="n">websockets</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="k">from</span> <span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"Hello world!"</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="k">yield</span> <span class="k">from</span> <span class="n">websocket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">yield</span> <span class="k">from</span>  <span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">input</span><span class="p">())</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">yield</span> <span class="k">from</span> <span class="n">websocket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">hello</span><span class="p">(</span><span class="s">'ws://localhost:8765'</span><span class="p">))</span></code></pre></figure>

<p>Note how to execute a native coroutine, or one decorated with <code class="highlighter-rouge">@asyncio.coroutine</code> in Python 3.4, needs to be executed by an event loop from the <code class="highlighter-rouge">asyncio</code> module.</p>

<h1 id="setting-things-up">
<a id="setting-things-up" class="anchor" href="#setting-things-up" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setting Things Up</h1>

<p>We shall now present the circuit that makes up the device that we want to control over the network, and both the server and client code that will allow us to use the gravity sensor of an Android device to operate it.</p>

<h2 id="the-circuitry">
<a id="the-circuitry" class="anchor" href="#the-circuitry" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Circuitry</h2>

<p>This part of the post will be brief, because we are going to recycle part of the previous post on IoT A Gentle Introduction to IoT. In fact, we are going to double it up by making a circuit with two LEDs, each one following the same design in the just mentioned post. The idea is to turn either one or the other on, depending on the rotation angle of our Android device. For example, if we tilt our device to the right, the green LED will become brighter, while when we tilt it to the left, the red LED will become brighter.</p>

<p>So, based on the knowledge acquired with the previous post on IoT, the circuit that we want to build will look like this.</p>

<p><img src="https://p403n1x87.github.io//images/ws_asyncio/ws_asyncio_bb.png" alt="Double LED configuration" class="center-image"></p>

<p>For this project I am using a Raspberry Pi 3 Model B. As you can see from the picture above, we need two LEDs, preferably of different colours, e.g. green and red, and two 220 Ω resistors. The green LED will be controlled via the BCM 18 (8) pin (green jumper wire), while the red one is controlled via the BCM 5 (29) pin (red jumper wire) of the Raspberry Pi. The black jumper wires indicate a connection on a ground pin.</p>

<h2 id="the-server-code">
<a id="the-server-code" class="anchor" href="#the-server-code" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Server Code</h2>

<p>The server code will run on the Raspberry Pi and will open a WebSocket server, listening for connection requests. At the moment of writing, Raspbian Jesse has Python 3.4.2 in its repository, so that we cannot benefit of the native Python coroutine offered by Python 3.5, unless we install this version manually.</p>

<p>All the server code can be found inside the <a href="https://github.com/P403n1x87/iot/tree/master/gravity_led/server">gravity_led/server</a> folder of the <a href="https://github.com/P403n1x87/iot">iot</a> repository. Due to its length I will refrain from embedding it on this post, but I will comment on the essential aspects.</p>

<p>The code is based on an abstract WebSocket Server class, <code class="highlighter-rouge">WSServer</code>, contained in <a href="https://github.com/P403n1x87/iot/blob/master/gravity_led/server/lib/wss.py">lib/wss.py</a>. An actual WebSocket server has to inherit from this class and implement the <code class="highlighter-rouge">handler</code> method, which is the one that bootstraps the logic of the server application. This will be called as soon as the WebSocket server starts serving connection requests.</p>

<p>On creation, we can specify the address and port the server is to listen on, as well as a possible limit on the number of simultaneous connections that the server is allowed to serve. Why would such a limit be ever necessary? The reason is that, in this particular example, we only have one device, and this can only be controlled by one client at a time. It makes no sense to accept more than one connection. By setting the limit to 1, we then prevent other clients from connecting and finding out that the device is already being controlled by another client. For the way it is implemented though, the class is flexible enough to allow changing this limit at run-time with a call to the <code class="highlighter-rouge">set_server_limit</code>.</p>

<p>After instantiation, we can run the server with a call to the <code class="highlighter-rouge">start</code> method, and we can check whether it is running at any time with <code class="highlighter-rouge">is_running</code>. Most of the code in the former method provides logging information and a graceful shutdown when the user presses Ctrl+C to halt the server.</p>

<p>The code contained in <a href="https://github.com/P403n1x87/iot/blob/master/gravity_led/server/main.py">main.py</a> is used to bootstrap the class <code class="highlighter-rouge">GyroListener</code> contained in <a href="https://github.com/P403n1x87/iot/blob/master/gravity_led/server/gyro_listener.py">gyro_listener.py</a>, which holds the actual logic of the server. As you can see, all that we have to do is inherit from <code class="highlighter-rouge">WSServer</code> and implement the <code class="highlighter-rouge">handler</code> coroutine, as shown here.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">@</span><span class="n">asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">websocket</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">conn_id</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Connection ID {} established [path {}]"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">conn_id</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>

    <span class="n">G</span><span class="o">.</span><span class="n">setmode</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">BOARD</span><span class="p">)</span>
    <span class="n">G</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">CHR</span><span class="p">,</span> <span class="n">G</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>
    <span class="n">G</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">CHL</span><span class="p">,</span> <span class="n">G</span><span class="o">.</span><span class="n">OUT</span><span class="p">)</span>

    <span class="n">pr</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">PWM</span><span class="p">(</span><span class="n">CHR</span><span class="p">,</span> <span class="n">FREQ</span><span class="p">)</span>
    <span class="n">pl</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">PWM</span><span class="p">(</span><span class="n">CHL</span><span class="p">,</span> <span class="n">FREQ</span><span class="p">)</span>
    <span class="n">pr</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gyro_data</span> <span class="o">=</span> <span class="k">yield</span> <span class="k">from</span> <span class="n">websocket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="n">g</span>         <span class="o">=</span> <span class="n">gyro_data</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">val</span>       <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">"Received datum {}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pr</span><span class="o">.</span><span class="n">ChangeDutyCycle</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">ChangeDutyCycle</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pr</span><span class="o">.</span><span class="n">ChangeDutyCycle</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">ChangeDutyCycle</span><span class="p">(</span><span class="o">-</span><span class="n">val</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">websockets</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionClosed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Connection ID {} closed."</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">conn_id</span><span class="p">))</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">break</span>

    <span class="n">G</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></code></pre></figure>

<p>Here we initialise the Pi’s GPIO and start listening to data over the socket until the server is running or the connection is closed by the client. The two pins that we have chosen to use to control the LEDs (<code class="highlighter-rouge">CHR</code> and <code class="highlighter-rouge">CHL</code>) are set on the PWM (Pulse Width Modulation) mode so that we can control the brightness: the more the Android device is tilted in one direction, the brighter the LED for that direction.</p>

<p>Here we also notice the “<em>contract</em>” between the server and the client: the latter will send the three coordinates of the gravity sensor as a space-separated list of three floating point values. The server will split this string and use the second component (the <em>y</em>-axis of the gravity sensor) to control the LEDs. When the value is positive the LED on the <code class="highlighter-rouge">CHR</code> pin will turn on, with a duty cycle proportional to the value passed by the client; when the value is negative the LED on the <code class="highlighter-rouge">CHL</code> pin will start to turn on.</p>

<p>To launch the server, run <code class="highlighter-rouge">main.py</code> and pass the IPv4 address and a port number, for example</p>

<div class="terminal"><div class="terminal-body flex-container flex-row">
<div class="pad-right"><pre>$ </pre></div>
<div><pre>
python3 main.py 0.0.0.0 5678
</pre></div>
</div></div>

<p>to listen on <em>any</em> IP address on the Raspberry Pi and accept connections from everywhere.</p>

<h2 id="the-client-code">
<a id="the-client-code" class="anchor" href="#the-client-code" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Client Code</h2>

<p>For the client, we are going to develop a minimalist Android application, with the same project structure that we have encountered in the previous post on <a href="/android/java/gradle/2017/10/14/android-dev.html">Android Development from the Command Line</a>. Again, the code is quite extensive, but you can find it in the <a href="https://github.com/P403n1x87/iot/tree/master/gravity_led/client">gravity_iot/client</a> folder. Apart from the minimal Android project setup, with the <code class="highlighter-rouge">AndroidManifest.xml</code> and the resource files for the UI, all that we need is a single activity where we can specify the IP address and the port of the server to connect to, and a toggle button to start and close a connection to the server.</p>

<p>For dealing with WebSockets in Java, we make use of the <a href="https://mvnrepository.com/artifact/org.java-websocket/Java-WebSocket">Java WebSockets</a> library, which offers the <code class="highlighter-rouge">WebSocketClient</code> abstract class. As you can see from the code in <a href="https://github.com/P403n1x87/iot/blob/master/gravity_led/client/src/main/java/MainActivity.java">MainActivity.java</a>, all that we have to do is extend the <code class="highlighter-rouge">WebSocketClient</code> class and implement a few methods, which we just use for logging purposes. The actual signalling is done via callbacks triggered by the on-board gravity sensor on the Android device:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSensorChanged</span><span class="o">(</span><span class="kd">final</span> <span class="n">SensorEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
  <span class="kt">float</span> <span class="n">x</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">values</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
  <span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">values</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
  <span class="kt">float</span> <span class="n">z</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">values</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>
  <span class="kt">float</span> <span class="n">g</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">sqrt</span><span class="o">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="o">);</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="n">webSocketClient</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">Float</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">x</span><span class="o">/</span><span class="n">g</span><span class="o">*</span><span class="mi">100</span><span class="o">)</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">Float</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">y</span><span class="o">/</span><span class="n">g</span><span class="o">*</span><span class="mi">100</span><span class="o">)</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">Float</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">z</span><span class="o">/</span><span class="n">g</span><span class="o">*</span><span class="mi">100</span><span class="o">));</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">WebsocketNotConnectedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">"ctrl_ws_client"</span><span class="o">,</span> <span class="s">"Sensor updated but socket not connected"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>This method is part of the <code class="highlighter-rouge">MainActivity</code> class since we decided that this should implement the <code class="highlighter-rouge">SensorEventListener</code> interface. When a connection is successfully started, we register the instance of this class with the sensor, so that when the value is changed a white-space separated list of the three components of the gravity vector are sent in text form to the server via the WebSocket.</p>

<p>We can use gradle to build and deploy the application for testing on a device with the command</p>

<div class="terminal"><div class="terminal-body flex-container flex-row">
<div class="pad-right"><pre>$ </pre></div>
<div><pre>
./gradlew installDebug
</pre></div>
</div></div>

<p>assuming that you have an Android device in developer mode connected to your building machine via USB. This is what it looks like on my Nexus 5</p>

<p><img src="https://p403n1x87.github.io//images/ws_asyncio/ctrl_ws_client.png" alt="ctrl_ws_client" class="center-image"></p>

<p>Before moving to the conclusion, just a quick note on the contents of the <code class="highlighter-rouge">AndroidManifest.xml</code> file. If you have had a look at it, you might have noticed the attribute <code class="highlighter-rouge">android:configChanges="orientation|screenSize"</code> on the <code class="highlighter-rouge">activity</code> element. This allows the application to rotate with the device orientation, without the application being restarted. If we do not put this attribute, any previous connection would be closed and we would have to restart it by pressing on the toggle button. The use of this attribute is not mandatory, but bear in mind that if you decide not to use it, then you would have to make sure that the same WebSocket connection is persisted across every screen rotation.</p>

<h1 id="conclusions">
<a id="conclusions" class="anchor" href="#conclusions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusions</h1>

<p>In the introduction, I have mentioned that WebSockets can be operated in two modes: <em>text</em> and <em>binary</em>. In the code that we have seen in this post we have sent <em>text</em> frames between the server and the client. This is because we have used data of type <code class="highlighter-rouge">String</code> in the Java client code, which is then received as <code class="highlighter-rouge">str</code> on the Python server end.</p>

<p>In most practical cases, it is more convenient to send a stream of bytes instead, thus increasing throughput. On the Java side, this is achieved by passing an array of bytes (<code class="highlighter-rouge">bytes[]</code>) to the <code class="highlighter-rouge">send</code> method. On the Python end, data will then be received as <code class="highlighter-rouge">bytes</code> (that is, the return value of the <code class="highlighter-rouge">recv</code> coroutine is of type <code class="highlighter-rouge">bytes</code>) that one can iterate over, or perform any necessary operation to make sense of the received information.</p>

<p>The same holds on reverse: if we send an array of bytes from Python, we will receive an binary frame on Java. In this case, though, we will have to implement the <code class="highlighter-rouge">ByteBuffer</code> version of the <code class="highlighter-rouge">onMessage</code> callback of the <code class="highlighter-rouge">WebSocketClient</code> class, i.e. the one with signature</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span> <span class="n">ByteBuffer</span> <span class="n">bytes</span> <span class="o">)</span></code></pre></figure>

<p>And with this we come to the end of this post :-).</p>

    </div>

    <div class="comments">
  <h1>Comments</h1>

  
    
    
    <ul class="comment-list">
      
        
        
      
    </ul>
  

  <h2 id="comment-hdr">Leave a comment</h2>
  <script src="https://p403n1x87.github.io//js/comments.js"></script>

<form id     = "post-comment"
      class  = "comment"
      method = "post"
      action = "">

  <input type        = "text"
         name        = "fields[name]"
         id          = "name"
         placeholder = "Name"/>

  <input type        = "text"
         name        = "fields[email]"
         placeholder = "E-mail address (optional; stored hashed for privacy)"/>

  <textarea name        = "fields[comment]"
            id          = "comment"
            rows        = "5"
            placeholder = "Write your comment here. You can use markdown and LaTeX (use $...$ to inline)"></textarea>

  <button type  = "button"
          class = "flat_button"
          id    = "btn-submit-comment"
          onClick="submitComment();">
    SUBMIT FOR APPROVAL
  </button>


  <!-- Hidden fields -->

   <input type  = "hidden"
          name  = "fields[pic]"
          value = "websockets_asyncio"/>

    <input type  = "hidden"
           id    = "timestamp"
           name  = "fields[timestamp]"
           value = "1557091937"/>

    <input type  = "hidden"
           id    = "parent"
           name  = "fields[parent]"
           value = "0"/>

</form>

<div id="snackbar"></div>


</div>

  </div>
</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">The Hub of Heliopolis</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>The Hub of Heliopolis is maintained by Gabriele N. Tornetta</li>
          <li><a href="mailto:phoenix1987@gmail.com">phoenix1987@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <i class="fa fa-github" aria-hidden="true"></i>&nbsp;<a href="https://github.com/P403n1x87"><span class="username">P403n1x87</span></a>

          </li>
          

          

          <li>
            <i class="fa fa-rss-square" aria-hidden="true"></i>&nbsp;<a href="/feed.xml">Subscribe</a>
          </li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>The Hub of Heliopolis is the <i>tech bay</i> of <a href="http://thenestofheliopolis.blogspot.co.uk/">The Nest of Heliopolis</a>. It is the home of all my <i>encounters</i> with technology that I consider worth sharing with the World.
</p>
      </div>
    </div>

    <div class="footer-copyright">
      Copyright (C) 2017 Gabriele N. Tornetta. All rights reserved.
    </div>

  </div>

</footer>


    
      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-104560783-1', 'auto');
  ga('send', 'pageview');

</script>

    

    <script src="https://use.fontawesome.com/8c7b940d60.js"></script>

    <!-- MathJax support -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>


  </body>

</html>
